<template>
  <PostFullDisplay
    :prioritizeLanguage="'en'"
    :key="'en' + title"
    :title="title"
    :content="content"
    :category="category"
    :mapPosition="mapPosition"
    :city="city"
    :date="date"
    :loading="loading"
    :slug="slug"
    :description="description"
    :publicPath="publicPath"
    :path="path"
    :image="image"
    :jaTitle="jaTitle"
    :polygons="polygons"
    :public="public"
    :preview="preview"
  />
</template>

<script>
import axios from 'axios'
import PostFullDisplay from '~/components/PostFullDisplay'
const { capitalize } = require('~/assets/commonFunctions.js')

export default {
  scrollToTop: true,
  head() {
    return {
      title: this.capitalize(this.title),
      meta: [
        { property: 'og:title', content: this.capitalize(this.title) },
        { hid: `og:type`, property: 'og:type', content: 'article' },
        {
          hid: `og:description`,
          property: 'og:description',
          content: this.description,
        },
        {
          property: 'description',
          content: this.description,
          hid: `description`,
        },
        {
          property: 'og:url',
          content: `https://www.travelingcircusofurbanism.com${
            this.publicPath
          }`,
        },
        {
          hid: `og:image`,
          property: 'og:image',
          content: this.image // does it have an image?
            ? this.image.substring(0, 4) === 'http' // is it external?
              ? this.image // if so, use it
              : `https://www.travelingcircusofurbanism.com${encodeURI(
                  this.image
                )}` // otherwise, give it a prefix
            : 'https://www.travelingcircusofurbanism.com/assets/sitethumbnail.jpg', // fallback to the site thumbnail.
        },
      ],
      // script: [
      //   { src: '/assets/pinit.js', defer: true, async: true, "data-pin-hover":"true", "data-pin-round":"true" }
      // ]
    }
  },

  components: {
    PostFullDisplay,
  },

  asyncData({ route, redirect, error, env, store }) {
    const removeTrailingSlash = string => string.replace(/\/$/, '')
    const slug = removeTrailingSlash(decodeURI(route.path))

    const path = '/posts' + slug + '/'
    const publicPath = slug + '/'

    let city = route.path.substring(1)
    city = decodeURI(city.substring(0, city.indexOf('/'))).toLowerCase()

    const autoGeneratedData = store.state.allPosts.find(
      p => city === p.city && slug.indexOf(p.slug) !== -1
    )
    if (!autoGeneratedData) {
      // console.log('Error: Unable to find generated data for ' + path)
      return error({ statusCode: 404, message: 'Page not found.' })
    }

    return {
      path,
      publicPath,
      slug,
      city,
      preview: autoGeneratedData.preview,
      jaTitle: autoGeneratedData.jaTitle,
      ...autoGeneratedData,
      mapPosition: autoGeneratedData.mapPosition
        ? Array.isArray(autoGeneratedData.mapPosition)
          ? autoGeneratedData.mapPosition
          : [autoGeneratedData.mapPosition]
        : [],
      polygons: autoGeneratedData.polygons ? autoGeneratedData.polygons : null,
    }
  },

  data() {
    return {
      loading: true,
      content: {
        en: null,
        ja: null,
      },
    }
  },

  async created() {
    if (!process.browser) return
    const axiosConfig = {
      validateStatus: status => true,
    }

    const contentPromises = []

    try {
      if (this.languages.en)
        contentPromises.push(
          axios
            .get(this.path + 'content.html', axiosConfig)
            .then(response => {
              this.$set(this.content, 'en', response.data)
            })
            .catch(e => console.log(e))
        )
      if (this.languages.ja)
        contentPromises.push(
          axios
            .get(this.path + 'ja.html', axiosConfig)
            .then(response => {
              this.$set(this.content, 'ja', response.data)
            })
            .catch(e => console.log(e))
        )
      await Promise.all(contentPromises)
    } catch (e) {
      console.log(e)
      return this.$router.push('/')
    }

    if (!(this.content.en || this.content.ja)) return this.$router.push('/')
    this.setLanguage(
      this.onlyShowLanguage === 'ja' || !this.content.en ? 'ja' : 'en'
    )
    this.loading = false
  },

  methods: {
    capitalize,

    setLanguage(language) {
      const prevLanguage = this.displayLanguage
      if (prevLanguage === language) return

      this.displayLanguage = language
      if (language === 'en') {
        this.$store.dispatch('setOnlyShowLanguage')
        this.$router.replace(this.publicPath.replace('/ja', ''))
      } else if (language === 'ja')
        this.$router.replace(
          this.publicPath
            .replace('/ja/', '/')
            .replace(
              /(\/?[^/]+\/)(.*)/g,
              (wholestring, firsthalf, secondhalf) =>
                firsthalf + 'ja/' + secondhalf
            )
        )
    },
  },
}
</script>

<style lang="scss" scoped>
</style>
